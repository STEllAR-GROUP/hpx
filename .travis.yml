language: cpp

sudo: false

compiler:
    #- gcc
    - clang

env:
    global:
        - GCC_VERSION="4.9.2"
        - CLANG_VERSION="3.6.0"
    matrix:
        - HPX_BUILD_TYPE=Debug
        - HPX_BUILD_TYPE=Release

branches:
    only:
        - master
        - release

cache:
    ccache: false
    directories:
        - deps

before_install:
    - export GCC_DIR="${TRAVIS_BUILD_DIR}/deps/gcc-${GCC_VERSION}"
    - export CLANG_DIR="${TRAVIS_BUILD_DIR}/deps/clang-${CLANG_VERSION}"

install:
    - FAILURE="0"
    - printenv
    - if [[ "$FAILURE" == "0" ]]; then ./travis/gcc.sh ${GCC_VERSION} || FAILURE="1"; fi
    - export CFLAGS="-I${GCC_DIR}/include"
    - export LDFLAGS="-L${GCC_DIR}/lib64"
    - export CPATH="${GCC_DIR}/include"
    - export LIBRARY_PATH="${GCC_DIR}/lib64"
    - export LD_LIBRARY_PATH="${GCC_DIR}/lib64"
    - export CC="${GCC_DIR}/bin/gcc"
    - export CXX="${GCC_DIR}/bin/g++"
    - if [[ "$FAILURE" == "0" ]]; then ./travis/clang.sh ${CLANG_VERSION} || FAILURE="1"; fi
    - export CC="${CLANG_DIR}/bin/clang"
    - export CXX="${CLANG_DIR}/bin/clang++"

before_script:
    - mkdir ${TRAVIS_BUILD_DIR}/build
    - cd ${TRAVIS_BUILD_DIR}/build

script:
    - if [[ "$FAILURE" == "0" ]]; then gcc --version; fi
    - if [[ "$FAILURE" == "0" ]]; then clang --version; fi
    - if [[ "$FAILURE" == "0" ]]; then cmake .. -DCMAKE_BUILD_TYPE=${HPX_BUILD_TYPE} -DHPX_MALLOC="system" -DHPX_BUILD_EXAMPLES=On -Wdev || FAILURE="1"; fi
    - if [[ "$FAILURE" == "0" ]]; then make core -j2 || FAILURE="1"; fi
    - if [[ "$FAILURE" == "0" ]]; then make -k components -j2 || FAILURE="1"; fi
    - if [[ "$FAILURE" == "0" ]]; then make -k examples -j2 || FAILURE="1"; fi
    - if [[ "$FAILURE" == "0" ]]; then ./bin/hello_world || FAILURE="1"; fi
    - test "$FAILURE" == "0"

notifications:
    email: false
