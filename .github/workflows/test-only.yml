name: Test Only

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID from successful build (leave empty for latest)'
        required: false
        type: string
  push:
    paths:
      - '.github/workflows/test-only.yml'

jobs:
  tests-example1:
    runs-on: ubuntu-latest
    container: stellargroup/build_env:17

    steps:
      - name: Download build artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-and-test.yml
          name: hpx-workspace
          path: /hpx/
          run_id: ${{ inputs.run_id || '' }}
          # If run_id is empty, downloads from latest successful run
      
      - uses: actions/checkout@v6
        with:
          path: /tmp/repo
          sparse-checkout: |
            .github
          sparse-checkout-cone-mode: false

      - name: Restore Executable Permissions 
        shell: bash
        run: |
          cp -r /tmp/repo/.github /hpx/source
          chmod -R +x /hpx/build/bin/ || true
          chmod -R +x /hpx/build/lib*/ || true

      - name: Running Example Tests
        shell: bash
        working-directory: /hpx/build
        run: |
          ulimit -c unlimited
          ctest \
            --timeout 180 \
            -T test \
            --no-compress-output \
            --output-on-failure \
            --tests-regex \
              `grep -v -e ^# -e ^$ /hpx/source/.github/test/targets/tests.examples1.targets | sed ':b;N;$!bb;s/\n/|/g'`
      
      - name: Collect test artifacts
        if: always()
        uses: /hpx/source/.github/actions/collect-artifacts
        with:
          job-name: tests-example1
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: tests-example1-artifacts
          path: /hpx/build/tests-example1/
