#  Copyright (c) 2017-2018 Thomas Heller
#  Copyright (c) 2015 Martin Stumpf
#  Copyright (c) 2022-2025 Hartmut Kaiser
#
#  SPDX-License-Identifier: BSL-1.0
#  Distributed under the Boost Software License, Version 1.0. (See accompanying
#  file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

working_dir_default: &working_dir_default # Setting the default working directory
    working_directory: /hpx/build

docker_default: &docker_default # Setting the default docker image
    docker:
      - image: stellargroup/build_env:17

defaults: &defaults # Defining a default anchor block
    <<: *working_dir_default
    <<: *docker_default

convert_xml: &convert_xml
    name: Converting XML
    when: always
    command: |
        mkdir -p ${CIRCLE_JOB}
        xsltproc \
          /hpx/conv.xsl Testing/`head -n 1 < Testing/TAG`/Test.xml \
          > ${CIRCLE_JOB}/Test.xml

move_core_dump: &move_core_dump
    name: Moving core dumps
    when: on_fail
    command: |
        mkdir -p ${CIRCLE_JOB}
        # Ignore errors if there are no core dumps
        cp core.* ${CIRCLE_JOB} || true

move_debug_log: &move_debug_log
    name: Moving debug logs
    when: on_fail
    command: |
        mkdir -p ${CIRCLE_JOB}
        cp debug-log.txt ${CIRCLE_JOB} || true

core_dependency: &core_dependency
    requires:
      - components

add_github_to_known_hosts: &add_github_to_known_hosts
    run:
        name: Add Github's key(s) to known_hosts
        command: |
            mkdir -p ~/.ssh
            ssh-keyscan -H github.com >>~/.ssh/known_hosts
configure_local_git: &configure_local_git
    run:
        name: Configure local Git
        command: |
            git config --global user.name "StellarBot"
            git config --global user.email "contact@stellar-group.org"


version: 2

jobs:
  checkout_code:
    <<: *docker_default
    working_directory: /hpx
    steps:
      - checkout:
          path: /hpx/source-full
      # Make a shallow clone of the current commit so that we don't have to copy
      # the whole repository between work steps.
      - run:
          name: Creating shallow clone
          command: |
              git clone --depth=1 file:///hpx/source-full source
      - run:
          name: Copying CTest XML to Junit XML
          command: |
              cp /hpx/source/.circleci/conv.xsl /hpx/conv.xsl
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./source
            - ./conv.xsl

  # Check if the files of the module are listed in the CMakeLists.txt
  # Check if all the module dependencies are listed
  check_module_cmakelists:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Check if the headers of the modules are listed in their CMakeLists.txt
          command: |
              /hpx/source/tools/check_module_cmakelists.sh
              if [[ $(wc -l /tmp/missing_files.txt | awk '{print $1}') -gt 1 ]] \
                  || [[ $(wc -l /tmp/missing_deps.txt | awk '{print $1}') -gt 1 ]]; \
                  then exit 1; fi
      - store_artifacts:
          path: /tmp/missing_files.txt
          destination: /hpx/artifacts/missing_files.txt
      - store_artifacts:
          path: /tmp/missing_deps.txt
          destination: /hpx/artifacts/missing_deps.txt

  configure:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Running CMake
          command: |
            cmake --version
            # Disable Vc for now as otherwise we need to reconfigure during the
            # install step, which in turn forces everything to be rebuilt.
            # -DHPX_WITH_DATAPAR_VC=On
            cmake \
                /hpx/source \
                -G "Ninja" \
                -DCMAKE_BUILD_TYPE=Debug \
                -DHPX_WITH_MALLOC=system \
                -DHPX_WITH_FETCH_ASIO=Off \
                -DHPX_WITH_DATAPAR_BACKEND=VC \
                -DHPX_WITH_GIT_COMMIT=${CIRCLE_SHA1} \
                -DHPX_WITH_GIT_BRANCH="${CIRCLE_BRANCH}" \
                -DHPX_WITH_GIT_TAG="${CIRCLE_TAG}" \
                -DHPX_WITH_TOOLS=On \
                -DCMAKE_CXX_FLAGS="-fcolor-diagnostics" \
                -DHPX_WITH_TESTS_HEADERS=On \
                -DHPX_WITH_COMPILER_WARNINGS=On \
                -DHPX_WITH_COMPILER_WARNINGS_AS_ERRORS=On \
                -DHPX_WITH_DEPRECATION_WARNINGS=On \
                -DCMAKE_CXX_CLANG_TIDY=clang-tidy-20 \
                -DHPX_WITH_THREAD_LOCAL_STORAGE=On \
                -DHPX_WITH_STACKTRACES_STATIC_SYMBOLS=On \
                -DHPX_WITH_STACKTRACES_DEMANGLE_SYMBOLS=Off \
                -DHPX_WITH_TESTS_DEBUG_LOG=On \
                -DHPX_WITH_TESTS_DEBUG_LOG_DESTINATION=/hpx/build/debug-log.txt \
                -DHPX_WITH_SPINLOCK_DEADLOCK_DETECTION=On \
                -DHPX_WITH_CHECK_MODULE_DEPENDENCIES=On \
                -DHPX_LOGGING_WITH_SEPARATE_DESTINATIONS=Off \
                -DHPX_WITH_THREAD_DEBUG_INFO=On \
                -DHPX_COMMAND_LINE_HANDLING_WITH_JSON_CONFIGURATION_FILES=On \
                -DHPX_WITH_FETCH_JSON=On \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=On \
                -DHPX_WITH_TESTS_COMMAND_LINE=--hpx:queuing=local-workrequesting-fifo \
                -DHPX_WITH_TESTS_MAX_THREADS_PER_LOCALITY=2
          no_output_timeout: 30m
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  configure_test_combinations:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Running CMake with tests on and examples off
          command: |
            cmake \
                /hpx/source \
                -G "Ninja" \
                -DHPX_WITH_MALLOC=system \
                -DHPX_WITH_FETCH_ASIO=Off \
                -DHPX_WITH_TESTS=On \
                -DHPX_WITH_EXAMPLES=Off
            rm -rf *
      - run:
          name: Running CMake with tests off and examples on
          command: |
            cmake \
                /hpx/source \
                -G "Ninja" \
                -DHPX_WITH_MALLOC=system \
                -DHPX_WITH_FETCH_ASIO=Off \
                -DHPX_WITH_TESTS=Off \
                -DHPX_WITH_EXAMPLES=On
            rm -rf *
      - run:
          name: Running CMake with APEX on
          command: |
            cmake \
                /hpx/source \
                -G "Ninja" \
                -DHPX_WITH_MALLOC=system \
                -DHPX_WITH_FETCH_ASIO=Off \
                -DHPX_WITH_APEX=On \
                -DHPX_WITH_FETCH_APEX=ON \
                -DHPX_WITH_TESTS=On \
                -DHPX_WITH_EXAMPLES=On
            rm -rf *
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  inspect:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Inspect Tool
          command: |
              ninja -j2 tools.inspect
      - run:
          name: Running Inspect Tool
          command: |
              ./bin/inspect --all --output=./hpx_inspect_report.html /hpx/source
      - run:
          name: Convert inspect HTML output to XML
          command: |
              mkdir -p /report
              /hpx/source/tools/inspect/inspect_to_junit.py \
                  ./hpx_inspect_report.html \
                  /report/hpx_inspect.xml
          when: always
      - store_artifacts:
          path: hpx_inspect_report.html
          destination: hpx_inspect_report.html
      - store_test_results:
          path: /report
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build/bin/inspect


  depreport:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building HPX Dependency Report Tool
          command: |
              ninja -j2 tools.hpxdep
      - run:
          name: Building HPX Dependency Report Documentation
          command: |
              ninja -j1 depreport
          no_output_timeout: 10m
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build/share/hpx/docs/report
      - store_artifacts:
          path: /hpx/build/share/hpx/docs/report

  core_local:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Core
          command: |
              ninja -j2 -k 0 hpx_core
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  core:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Core
          command: |
              ninja -j2 -k 0 core
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  components:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Components
          command: |
              ninja -j2 -k 0 components
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  tests.examples1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Examples (1)
          command: |
              ninja -j2 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.examples1.targets`
      - run:
          name: Running Example Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.examples1.targets | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.examples1
      - store_artifacts:
          path: tests.examples1
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  tests.examples2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Examples (2)
          command: |
              ninja -j2 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.examples2.targets`
      - run:
          name: Running Example Tests
          when: always
          command: |
              ulimit -c unlimited
              # NOTE: transpose_block_numa is disabled because
              # hwloc_get_area_membind_nodeset (which is used by the
              # numa_allocator) fails with EPERM.
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.examples2.targets | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                  tests.examples.transpose.transpose_block_numa
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.examples2
      - store_artifacts:
          path: tests.examples2
      - persist_to_workspace:
          root: /hpx
          paths:
            - ./build

  tests.unit1.algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Algorithms, 1)
          command: |
              ninja -j1 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit1.algorithms
      - store_artifacts:
          path: tests.unit1.algorithms

  tests.unit2.algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Algorithms, 2)
          command: |
              ninja -j1 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit2.algorithms
      - store_artifacts:
          path: tests.unit2.algorithms

  tests.unit3.algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Algorithms, 3)
          command: |
              ninja -j1 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit3.algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit3.algorithms | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                  tests.unit.modules.algorithms.algorithms.foreach_std_policies
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit3.algorithms
      - store_artifacts:
          path: tests.unit3.algorithms

  tests.unit4.algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Algorithms, 4)
          command: |
              ninja -j1 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit4.algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit4.algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit4.algorithms
      - store_artifacts:
          path: tests.unit4.algorithms

  tests.unit1.container_algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Container Algorithms, 1)
          command: |
              ninja -j2 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.container_algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 120 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.container_algorithms | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                  tests.unit.modules.algorithms.container_algorithms.for_loop_range_generator
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit1.container_algorithms
      - store_artifacts:
          path: tests.unit1.container_algorithms

  tests.unit2.container_algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Container Algorithms, 2)
          command: |
              ninja -j2 -k 0 \
                `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.container_algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 120 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.container_algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit2.container_algorithms
      - store_artifacts:
          path: tests.unit2.container_algorithms

  tests.unit1.segmented_algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Segmented Algorithms, 1)
          command: |
              ninja -j1 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.segmented_algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 270 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.segmented_algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit1.segmented_algorithms
      - store_artifacts:
          path: tests.unit1.segmented_algorithms

  tests.unit2.segmented_algorithms:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (Segmented Algorithms, 2)
          command: |
              ninja -j1 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.segmented_algorithms`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 270 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex \
                  `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.segmented_algorithms | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit2.segmented_algorithms
      - store_artifacts:
          path: tests.unit2.segmented_algorithms

  tests.unit1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (1)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.targets`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit1.targets | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit1
      - store_artifacts:
          path: tests.unit1

  tests.unit2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (2)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.targets`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              # NOTE: the numa_allocator test is disabled because
              # hwloc_get_area_membind_nodeset used by it fails with EPERM.
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit2.targets | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                  "tests.unit.modules.compute_local.numa_allocator"
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit2
      - store_artifacts:
          path: tests.unit2

  tests.unit3:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (3)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit3.targets`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit3.targets | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit3
      - store_artifacts:
          path: tests.unit3

  tests.unit4:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (4)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit4.targets`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit4.targets | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                    "tests.unit.modules.resource_partitioner.scheduler_binding_check"
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit4
      - store_artifacts:
          path: tests.unit4

  tests.unit5:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Unit Tests (5)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit5.targets`
      - run:
          name: Running Unit Tests
          when: always
          command: |
              ulimit -c unlimited
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.unit5.targets | sed ':b;N;$!bb;s/\n/|/g'`
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.unit5
      - store_artifacts:
          path: tests.unit5

  tests.regressions1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Regressions Tests (1)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.regressions1.targets`
      - run:
          name: Running Regressions Tests
          when: always
          command: |
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.regressions1.targets | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                    "tests.regressions.modules.threading_base.thread_stacksize_current"
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.regressions1
      - store_artifacts:
          path: tests.regressions1

  tests.regressions2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Regressions Tests (2)
          command: |
              ninja -j2 -k 0 `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.regressions2.targets`
      - run:
          name: Running Regressions Tests
          when: always
          command: |
              ctest \
                --timeout 180 \
                -T test \
                --no-compress-output \
                --output-on-failure \
                --tests-regex `grep -v -e ^# -e ^$ /hpx/source/.circleci/tests.regressions2.targets | sed ':b;N;$!bb;s/\n/|/g'` \
                --exclude-regex \
                    "tests.regressions.modules.command_line_handling_local|\
                    tests.regressions.modules.parcelset.distributed.tcp.nested_vectors_6623|\
                    tests.regressions.modules.parcelset.distributed.tcp.very_big_tchunk|\
                    tests.regressions.modules.parcelset.distributed.tcp.very_big_parcel|\
                    tests.regressions.modules.parcelset.distributed.tcp.very_big_parcel_int_max_plus_1"
      - run:
          <<: *convert_xml
      - run:
          <<: *move_core_dump
      - run:
          <<: *move_debug_log
      - store_test_results:
          path: tests.regressions2
      - store_artifacts:
          path: tests.regressions2

  tests.headers1_1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 1/1)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[q-s].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers1_1
      - store_artifacts:
          path: tests.headers1_1

  tests.headers1_2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 1/2)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[t-z].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers1_2
      - store_artifacts:
          path: tests.headers1_2

  tests.headers2_1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 2/1)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.a[a-h].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers2_1
      - store_artifacts:
          path: tests.headers2_1

  tests.headers2_2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 2/2)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.al.*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers2_2
      - store_artifacts:
          path: tests.headers2_2

  tests.headers2_3:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 2/3)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.((a[m-z])|b).*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers2_3
      - store_artifacts:
          path: tests.headers2_3

  tests.headers3_1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 3/1)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[c-d].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers3_1
      - store_artifacts:
          path: tests.headers3_1

  tests.headers3_2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 3/2)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[e-h].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers3_2
      - store_artifacts:
          path: tests.headers3_2

  tests.headers4_1:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 4/1)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[i-l].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers4_1
      - store_artifacts:
          path: tests.headers4_2

  tests.headers4_2:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Header Tests (part 4/2)
          command: |
              ctest --timeout 60 -j1 -T test --no-compress-output --output-on-failure \
                -R "tests.headers.modules.[m-p].*"
      - run:
          <<: *convert_xml
      - store_test_results:
          path: tests.headers4_2
      - store_artifacts:
          path: tests.headers4_2

  tests.performance:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /hpx
      - run:
          name: Building Performance Tests
          command: |
              ninja -j2 -k 0 tests.performance

  install:
    <<: *docker_default
    environment:
      TARGET_IMAGE_NAME: stellargroup/hpx:dev
    steps:
      - attach_workspace:
          at: /hpx
      - setup_remote_docker
      - run:
          name: Installing
          command: |
              ./bin/hello_world_distributed --hpx:bind=none
              # Disable Vc here as the target machine of the container image may
              # not support the same vector intrinsics as this machine. The
              # "Test Docker Image" below fails with "Illegal instruction" if VC
              # is enabled, and other machines may fail similarly.
              #
              # Having to reconfigure here forces everything to be rebuilt, thus
              # we disable it altogether.
              #
              # cmake \
              #   -DHPX_WITH_DATAPAR_VC=Off .
              ninja -v -j2 install
          working_directory: /hpx/build
          when: always
          no_output_timeout: 30m
      - run:
          name: Testing build unit tests
          command: |
              ninja -j2 tests.unit.build
          working_directory: /hpx/build
          when: always
      - run:
          name: Testing installed HPX
          shell: /bin/bash
          command: |
              hello_world_distributed --hpx:bind=none
              ldconfig
              hpxcxx --exe=hello_world_distributed_test_build ../source/examples/quickstart/hello_world_distributed.cpp -g -lhpx_iostreamsd
              ./hello_world_distributed_test_build --hpx:bind=none
              hpxrun.py -l 2 -t 1 ./hello_world_distributed_test_build -- --hpx:bind=none
          working_directory: /hpx/build
          no_output_timeout: 10m
          when: always
      - run:
          name: Create Docker Image
          command: |
              cp /hpx/source/tools/docker/Dockerfile .
              VER="18.03.0-ce"
              curl -L -o /tmp/docker-$VER.tgz https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz
              tar -xz -C /tmp -f /tmp/docker-$VER.tgz
              mv /tmp/docker/* /usr/bin
              docker build -t ${TARGET_IMAGE_NAME} .
          working_directory: /usr/local
          when: always
      - run:
          name: Test Docker Image
          command: |
              docker run ${TARGET_IMAGE_NAME} hello_world_distributed --hpx:bind=none
              docker create -v /hpx --name sources stellargroup/hpx:dev /bin/true
              docker cp ./source/examples/quickstart/hello_world_distributed.cpp sources:/hpx
              docker run --volumes-from sources -w /hpx ${TARGET_IMAGE_NAME} \
                hpxcxx --exe=hello_world_distributed_test_build              \
                hello_world_distributed.cpp -g -lhpx_iostreamsd
              docker run --volumes-from sources -w /hpx ${TARGET_IMAGE_NAME} \
                ./hello_world_distributed_test_build --hpx:bind=none
              docker run --volumes-from sources -w /hpx ${TARGET_IMAGE_NAME} \
                hpxrun.py -l 2 -t 2 ./hello_world_distributed_test_build -- --hpx:bind=none
          working_directory: /hpx
      - <<: *add_github_to_known_hosts
      - <<: *configure_local_git
      - run:
          name: Push Docker Image
          command: |
              if [[ -z "$CIRCLE_PR_NUMBER" ]] && [[ "$CIRCLE_BRANCH" == "master" ]]; then
                  docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
                  docker push ${TARGET_IMAGE_NAME}
              else
                  echo "Not on the master branch. The docker image will not be pushed."
              fi

  # This is the final step once everything else passes. We need a full clone
  # here again to be able to push the new tag.
  push_stable_tag:
    <<: *docker_default
    steps:
      - checkout:
          path: /hpx/source
      - <<: *add_github_to_known_hosts
      - <<: *configure_local_git
      - run:
          name: Push stable tag
          command: |
              if [[ -z "$CIRCLE_PR_NUMBER" ]] && [[ "$CIRCLE_BRANCH" == "master" ]]; then
                  # Tag the commit
                  cd /hpx/source
                  git tag -f stable
                  ##########################################################
                  # NOTE: Dependency on the Docker push is so that users who
                  # use the Docker image would not be confused. Do not change
                  # the order before considering every use case.
                  ##########################################################
                  # Remove the old tag
                  git push origin :refs/tags/stable
                  # Push the new stable commit tag
                  git push origin stable
              else
                  echo "Not on the master branch. The commit will not be tagged."
              fi

workflows:
  version: 2
  build-and-test:
    jobs:
      - spellcheck
      - checkout_code
      - check_circular_deps:
          requires:
            - checkout_code
      - check_module_cmakelists:
          requires:
            - checkout_code
      - clang_format:
          requires:
            - checkout_code
      - cmake_format:
          requires:
            - checkout_code
      - configure:
          requires:
            - checkout_code
      - configure_test_combinations:
          requires:
            - checkout_code
      - inspect:
          requires:
            - configure
      - depreport:
          requires:
            - configure
      - core_local:
          requires:
            - configure
      - core:
          requires:
            - core_local
      - components:
          requires:
            - core
      - tests.examples1:
          <<: *core_dependency
      - tests.examples2:
          <<: *core_dependency
      - tests.unit1.algorithms:
          <<: *core_dependency
      - tests.unit2.algorithms:
          <<: *core_dependency
      - tests.unit3.algorithms:
          <<: *core_dependency
      - tests.unit4.algorithms:
          <<: *core_dependency
      - tests.unit1.container_algorithms:
          <<: *core_dependency
      - tests.unit2.container_algorithms:
          <<: *core_dependency
      - tests.unit1.segmented_algorithms:
          <<: *core_dependency
      - tests.unit2.segmented_algorithms:
          <<: *core_dependency
      - tests.unit1:
          <<: *core_dependency
      - tests.unit2:
          <<: *core_dependency
      - tests.unit3:
          <<: *core_dependency
      - tests.unit4:
          <<: *core_dependency
      - tests.unit5:
          <<: *core_dependency
      - tests.regressions1:
          <<: *core_dependency
      - tests.regressions2:
          <<: *core_dependency
      - tests.performance:
          <<: *core_dependency
      - tests.headers1_1:
          <<: *core_dependency
      - tests.headers1_2:
          <<: *core_dependency
      - tests.headers2_1:
          <<: *core_dependency
      - tests.headers2_2:
          <<: *core_dependency
      - tests.headers2_3:
          <<: *core_dependency
      - tests.headers3_1:
          <<: *core_dependency
      - tests.headers3_2:
          <<: *core_dependency
      - tests.headers4_1:
          <<: *core_dependency
      - tests.headers4_2:
          <<: *core_dependency
      - install:
          requires:
            - core
            - tests.examples2
            - tests.unit1.algorithms
            - tests.unit2.algorithms
            - tests.unit3.algorithms
            - tests.unit4.algorithms
            - tests.unit1.container_algorithms
            - tests.unit2.container_algorithms
            - tests.unit1.segmented_algorithms
            - tests.unit2.segmented_algorithms
            - tests.unit1
            - tests.unit2
            - tests.unit3
            - tests.unit4
            - tests.unit5
            - tests.regressions1
            - tests.regressions2
            - tests.performance
            - tests.headers1_1
            - tests.headers1_2
            - tests.headers2_1
            - tests.headers2_2
            - tests.headers2_3
            - tests.headers3_1
            - tests.headers3_2
            - tests.headers4_1
            - tests.headers4_2
            # prevent inspect from being rebuilt
            - inspect
      - push_stable_tag:
          requires:
            - install
